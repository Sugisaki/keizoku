# アプリケーション仕様書

このドキュメントは、現在のカレンダーアプリケーションの技術的な仕様をまとめたものです。

## 1. 全体アーキテクチャ

このアプリケーションは、UI、状態管理、データ操作の関心を分離する設計を採用しています。

-   **UI (View) 層:** Flutterのウィジェットで構築された画面です。
-   **状態管理 (State Management) 層:** `provider`パッケージの`ChangeNotifier`を利用して、UIの状態を一元管理します。
-   **データ (Repository) 層:** 「リポジトリパターン」を採用し、データの永続化ロジックを抽象化しています。これにより、将来的にローカル保存からクラウド保存への切り替えが容易になります。

## 2. データモデル (`lib/models/`)

アプリケーション内で使用される主要なデータ構造です。

-   `CalendarSettings`: カレンダーの表示設定（週の開始曜日、カラーパレットなど）を管理します。
-   `CalendarItem`: 記録する「事柄」の定義（ID, 名称, 色, アイコン）です。
-   `CalendarRecords`: 日付(`DateTime`)と、その日に記録された事柄IDのリスト(`List<int>`)を紐付けるマップを管理します。
-   `LanguageSettings`: アプリ内で使用する言語設定（選択された言語ロケール）を管理します。

## 3. 永続化 (`lib/repositories/`)

データのリポジトリパターンに基づいた実装です。

-   **インターフェース:**
    -   `SettingsRepository`: 設定の保存・読み込み操作を定義します。
    -   `RecordsRepository`: 記録の保存・読み込み操作を定義します。
    -   `LanguageRepository`: 言語設定の保存・読み込み操作を定義します。
-   **ローカル実装 (`lib/repositories/local/`):**
    -   `LocalSettingsRepository`: `shared_preferences` を使用して設定データをデバイスに保存します。
    -   `LocalRecordsRepository`: `path_provider` を使用して取得したパスに、記録データをJSONファイルとして保存します。
    -   `LocalLanguageRepository`: `shared_preferences` を使用して言語設定データをデバイスに保存します。

## 4. 状態管理 (`lib/providers/`)

-   `CalendarProvider`: `ChangeNotifier`を継承したクラス。リポジトリを通じてデータをロード・セーブし、UIの更新を`notifyListeners()`で通知します。アプリケーション全体の状態（設定、事柄リスト、記録、言語設定）を保持します。

## 5. UIコンポーネント (`lib/widgets/`)

-   `CalendarWidget`:
    -   カレンダー全体の表示を担うメインウィジェットです。
    -   縦スクロールが可能で、最も古い記録がある月まで遡ることができます。
    -   初期表示では、今月の最終週が一番下に表示されます。
    -   画面上部に表示されている週に応じて、AppBarのタイトル（年月）が動的に更新されます。
    -   外部からのスクロール制御をサポートする`CalendarWidgetController`を提供します。
-   `WeekRowWidget`: 1週間分の行を描画します。7日分の`DayCellWidget`と、その週に記録があった事柄を示すラインで構成されます。
-   `DayCellWidget`: 1日分のセルを描画します。日付、および記録された事柄のアイコンを3x3のグリッドで表示します。スクロール中は表示月以外の日の文字色が通常色になります。

## 6. 画面 (`lib/screens/` & `lib/main.dart`)

-   `MyHomePage`: カレンダー画面のメインとなるScaffoldです。`CalendarWidget`を表示し、AppBarやフローティングアクションボタンを配置します。カレンダーの下部に「今日」ボタンを配置し、タップすると最新の週（一番下）にスクロールします。
-   `SettingsScreen`: 週の開始曜日や言語設定などを行う画面です。
-   `AddRecordDialog`: その日の事柄を記録するためのモーダルダイアログです。

## 7. 多言語対応 (Internationalization)

アプリケーションは12つの言語に対応しており、ユーザーはアプリ内で言語を選択できます。

### 7.1 対応言語
-   **英語** (en): 国際標準言語（非対応言語のフォールバック）
-   **日本語** (ja): 日本向け
-   **中国語簡体字** (zh): 中国本土向け
-   **中国語繁体字** (zh_TW): 台湾・香港向け
-   **韓国語** (ko): 韓国向け
-   **フランス語** (fr): フランス語圏向け
-   **ドイツ語** (de): ドイツ語圏向け
-   **スペイン語** (es): スペイン語圏向け
-   **ヒンディー語** (hi): インド向け
-   **インドネシア語** (id): インドネシア向け
-   **ポルトガル語** (pt): ブラジル・ポルトガル向け
-   **アラビア語** (ar): アラビア語圏向け

### 7.2 国際化ファイル (`lib/l10n/`)
-   `app_en.arb`: 英語翻訳（テンプレートファイル）
-   `app_ja.arb`: 日本語翻訳
-   `app_zh.arb`: 中国語簡体字翻訳
-   `app_zh_TW.arb`: 中国語繁体字翻訳
-   `app_ko.arb`: 韓国語翻訳
-   `app_fr.arb`: フランス語翻訳
-   `app_de.arb`: ドイツ語翻訳
-   `app_es.arb`: スペイン語翻訳
-   `app_hi.arb`: ヒンディー語翻訳
-   `app_id.arb`: インドネシア語翻訳
-   `app_pt.arb`: ポルトガル語翻訳
-   `app_ar.arb`: アラビア語翻訳
-   `app_localizations.dart`: 自動生成される国際化クラス

### 7.3 翻訳対象
-   **UI文字列**: ボタンテキスト、ラベル、メッセージ
-   **曜日表示**: カレンダーヘッダーの曜日略称
-   **月表示**: AppBarの年月表示（システムロケール対応）
-   **設定項目**: 設定画面のすべての項目名
-   **編集画面**: 編集画面のすべての項目名

### 7.4 言語選択機能
-   **設定画面**: 「言語」項目から言語を選択
-   **System Default**: 端末の言語設定に従う（完全一致→言語コード一致→英語フォールバック）
-   **即座反映**: 選択と同時にアプリ全体に適用
-   **永続化**: 選択した言語設定を保存し、アプリ再起動後も維持
-   **自動検出**: 初回起動時は端末言語を自動検出してデフォルト言語を決定

### 7.5 技術実装
-   **Flutter Localizations**: `flutter_localizations`パッケージを使用
-   **ARBファイル**: Application Resource Bundle形式で翻訳を管理
-   **動的切り替え**: `MaterialApp`の`locale`プロパティで言語を動的変更
-   **状態管理**: `CalendarProvider`で言語設定を一元管理

## 8. 高さ制限

-   `main.dart`にて、`MediaQuery`で画面サイズを取得し、1週あたりの高さを動的に計算します。
-   画面の縦サイズの半分を超えない、最大の行数（整数）を算出し、その高さでカレンダー領域を制限しています。

## 9. 開発環境のテストファイル、事柄記録データ
-   assets/test_calendar_records.json
-   テストファイルが存在する場合は、データをファイルに保存しない
